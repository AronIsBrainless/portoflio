<!DOCTYPE html>
<html>
<head>
    <title>Download Page</title>
</head>
<body>

    <div id="status">Checking for updates...</div>

    <script>
        // 2. DEFINE VARIABLE GLOBALLY 
        // This ensures 'finalDownloadLink' can be accessed anywhere.
        let finalDownloadLink = ""; 

        async function getNewestDownload() {
            try {
                const response = await fetch('/api/gdf_classic/var/current_data.xml');
                const xmlText = await response.text();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");

                const newestTag = xmlDoc.querySelector("newest-ver");
                const targetClass = newestTag.getAttribute("class");

                const versions = xmlDoc.getElementsByTagName("version");
                
                for (let v of versions) {
                    if (v.getAttribute("class") === targetClass) {
                        // 3. ASSIGN VALUE TO GLOBAL VARIABLE
                        finalDownloadLink = v.getAttribute("download-link");
                        break; 
                    }
                }

                // 4. NULL CHECK
                // We check if the element exists before trying to change it
                const statusElement = document.getElementById("status");
                
                if (statusElement) {
                    if (finalDownloadLink) {
                        statusElement.innerHTML = `<a href="${finalDownloadLink}">Download Version ${targetClass}</a>`;
                    } else {
                        statusElement.innerText = "Link not found for class: " + targetClass;
                    }
                }

            } catch (error) {
                console.error("Error loading XML:", error);
                const statusElement = document.getElementById("status");
                if (statusElement) statusElement.innerText = "Failed to load data.";
            }
        }

        // 5. RUN AFTER DOM IS READY
        // This prevents the "null" error by waiting for the page to load
        window.addEventListener('DOMContentLoaded', getNewestDownload);
    </script>
</body>
</html>